user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 4096;
	# multi_accept on;
}

http {
	sendfile on;
	tcp_nopush on;
	keepalive_timeout 3m;
	server_tokens off;
	msie_padding off;

	charset utf-8;

	include /etc/nginx/mime.types;
	default_type application/octet-stream;

	# SSL Settings
	ssl_certificate /etc/ssl/certificates/wildcardCert/wildcardCert.crt;
	ssl_certificate_key /etc/ssl/certificates/wildcardCert/wildcardCert.key;

	ssl_session_timeout 1d;
	ssl_session_cache shared:MozSSL:10m;
	ssl_session_tickets off;

	# Modern Configuration
	ssl_protocols TLSv1.3;
	ssl_prefer_server_ciphers off;

	server_names_hash_bucket_size 128;

	# Logging Settings
	access_log /var/log/nginx/access.log;
	error_log /var/log/nginx/error.log;

	# Gzip Settings
	# gzip on;

	gzip_vary on;
	gzip_proxied any;

	include /etc/nginx/conf.d/*.conf;
	include /etc/nginx/sites-enabled/*;

	# HTTP To HTTPS Redirect
	server {
		listen 80;
		listen [::]:80;
		server_name lotns.dedyn.io unordinary.dedyn.io api.lotns.dedyn.io fonts.lotns.dedyn.io blog.lotns.dedyn.io status.lotns.dedyn.io about.soracloud.dedyn.io soradns.dedyn.io soracloud.dedyn.io;

		return 308 https://$host$request_uri;
	}

	# LOTNS Foundation
	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name lotns.dedyn.io;

		include snippets/security-headers-base.conf;

		location / {
			include snippets/sub_filter-private.conf;
		}

		root /var/www/lotns;
		include snippets/errors.conf;
	}

	# About Izumi Sena Sora
	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name unordinary.dedyn.io;

		include snippets/security-headers-base.conf;

		location / {
			include snippets/sub_filter-private.conf;
		}

		root /var/www/unordinary;
		include snippets/errors.conf;
	}

	# SoraAPI LLC
	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name api.lotns.dedyn.io;

		include snippets/security-headers-base.conf;

		location ~ \.(?:css|js|mjs|woff2|svg|webp|png)$ {
			add_header Cache-Control "public, max-age=31536000, immutable";
			add_header Access-Control-Allow-Origin "*" always;
			include snippets/security-headers-base.conf;
		}

		location / {
			include snippets/sub_filter-private.conf;
		}

		root /var/www/api;
		include snippets/errors.conf;
	}

	# SoraFonts LLC
	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name fonts.lotns.dedyn.io;

		include snippets/security-headers-base.conf;

		location ~ \.(?:css|js|mjs|woff2|svg|webp|png)$ {
			add_header Cache-Control "public, max-age=31536000, immutable";
			add_header Access-Control-Allow-Origin "*" always;
			include snippets/security-headers-base.conf;
		}

		location / {
			include snippets/sub_filter-private.conf;
		}

		root /var/www/fonts;
		include snippets/errors.conf;
	}

	# SoraBlog LLC
	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name blog.lotns.dedyn.io;

		include snippets/security-headers-base.conf;

		location / {
			include snippets/sub_filter-private.conf;
		}

		root /var/www/blog;
		include snippets/errors.conf;
	}

	# SoraStatus LLC
	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name status.lotns.dedyn.io;

		include snippets/security-headers-base.conf;

		location / {
			include snippets/sub_filter-private.conf;
		}

		root /var/www/status;
		include snippets/errors.conf;
	}

	# About SoraCloud LLC
	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name about.soracloud.dedyn.io;

		include snippets/security-headers-base.conf;

		location / {
			include snippets/sub_filter-private.conf;
		}

		root /var/www/about-soracloud;
		include snippets/errors.conf;
	}

	# SoraDNS LLC
	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name soradns.dedyn.io;

		include snippets/security-headers-base.conf;

		location / {
			proxy_pass https://soradns.dedyn.io:8443;
			include snippets/sub_filter-private.conf;
		}

		include snippets/errors.conf;
	}

	# SoraCloud LLC
	upstream php-handler {
		server unix:/var/run/php/php7.4-fpm.sock;
	}

	server {
		listen 443 ssl http2;
		listen [::]:443 ssl http2;
		server_name soracloud.dedyn.io;

		include snippets/security-headers-base.conf;
		add_header X-Download-Options "noopen" always;
		add_header X-Permitted-Cross-Domain-Policies "none" always;

		# Remove X-Powered-By, which is an information leak
		fastcgi_hide_header X-Powered-By;

		# Path to the root of your installation
		root /var/www/soracloud;

		location = /robots.txt {
			allow all;
			log_not_found off;
			access_log off;
		}

		# The following 2 rules are only needed for the user_webfinger app.
		# Uncomment it if you're planning to use this app.
		# rewrite ^/.well-known/host-meta /public.php?service=host-meta last;
		# rewrite ^/.well-known/host-meta.json /public.php?service=host-meta-json last;

		# The following rule is only needed for the Social app.
		# Uncomment it if you're planning to use this app.
		# rewrite ^/.well-known/webfinger /public.php?service=webfinger last;

		location = /.well-known/carddav {
			return 308 $scheme://$host:$server_port/remote.php/dav;
		}

		location = /.well-known/caldav {
			return 308 $scheme://$host:$server_port/remote.php/dav;
		}

		location = /.well-known/webfinger {
			return 308 $scheme://$host:$server_port/index.php/.well-known/webfinger;
		}

		location = /.well-known/nodeinfo {
			return 308 $scheme://$host:$server_port/index.php/.well-known/nodeinfo;
		}

		# set max upload size
		client_max_body_size 512M;
		fastcgi_buffers 64 4K;


		# Uncomment if your server is build with the ngx_pagespeed module
		# This module is currently not supported.
		#pagespeed off;

		location / {
			rewrite ^ /index.php;
			include snippets/sub_filter-private.conf;
		}

		location ~ ^\/(?:build|tests|config|lib|3rdparty|templates|data)\/ {
			deny all;
		}

		location ~ ^\/(?:\.|autotest|occ|issue|indie|db_|console) {
			deny all;
		}

		location ~ ^\/(?:index|remote|public|cron|core\/ajax\/update|status|ocs\/v[12]|updater\/.+|oc[ms]-provider\/.+|.+\/richdocumentscode\/proxy)\.php(?:$|\/) {
			fastcgi_split_path_info ^(.+?\.php)(\/.*|)$;
			set $path_info $fastcgi_path_info;
			try_files $fastcgi_script_name =404;
			include fastcgi_params;
			fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
			fastcgi_param PATH_INFO $path_info;
			fastcgi_param HTTPS on;
			# Avoid sending the security headers twice
			fastcgi_param modHeadersAvailable true;
			# Enable pretty urls
			fastcgi_param front_controller_active true;
			fastcgi_pass php-handler;
			fastcgi_intercept_errors on;
			fastcgi_request_buffering off;
		}

		location ~ ^\/(?:updater|oc[ms]-provider)(?:$|\/) {
			try_files $uri/ =404;
			index index.php;
		}

		# Adding the cache control header for js, css and map files
		# Make sure it is BELOW the PHP block
		location ~ \.(?:css|js|woff2?|svg|gif|map)$ {
			try_files $uri /index.php$request_uri;
			add_header Cache-Control "public, max-age=31536000, immutable";
			include snippets/security-headers-base.conf;
			add_header X-Download-Options "noopen" always;
			add_header X-Permitted-Cross-Domain-Policies "none" always;
			# Optional: Don't log access to assets
			access_log off;
		}

		location ~ \.(?:png|html|ttf|ico|jpg|jpeg|bcmap|mp4|webm)$ {
			try_files $uri /index.php$request_uri;
			# Optional: Don't log access to other assets
			access_log off;
		}

		location ^~ /push/ {
			proxy_pass http://127.0.0.1:7867/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "Upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		}
	}
}
